<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant - Planner App</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #e5f2ff 0%, #ffffff 100%);
            min-height: 100vh;
        }
        
        .assistant-header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }

        /* Header Logo */
        .header-logo {
            width: 50px !important;
            height: 50px !important;
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%) !important;
            border-radius: 12px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            color: white !important;
            font-size: 1.5rem !important;
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3) !important;
        }

        .header-title {
            color: #2c3e50 !important;
            font-weight: 600 !important;
            font-size: 1.5rem !important;
        }

        .header-subtitle {
            font-size: 0.85rem !important;
            color: #7f8c8d !important;
        }

        /* Header Navigation */
        .header-nav {
            display: flex !important;
            align-items: center !important;
            justify-content: flex-end !important;
            gap: 1rem !important;
        }

        .nav-buttons {
            display: flex !important;
            gap: 0.5rem !important;
            align-items: center !important;
        }

        .nav-btn {
            display: flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
            padding: 0.6rem 1rem !important;
            border: none !important;
            border-radius: 10px !important;
            background: rgba(255, 255, 255, 0.8) !important;
            color: #2c3e50 !important;
            text-decoration: none !important;
            font-size: 0.9rem !important;
            font-weight: 500 !important;
            transition: all 0.3s ease !important;
            backdrop-filter: blur(10px) !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
        }

        .nav-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15) !important;
            text-decoration: none !important;
        }

        .nav-btn i {
            font-size: 1rem !important;
        }

        .btn-text {
            display: inline !important;
        }

        /* Specific button styles */
        .timezone-btn {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%) !important;
            color: white !important;
        }

        .timezone-btn:hover {
            background: linear-gradient(135deg, #7f8c8d 0%, #6c7b7d 100%) !important;
            color: white !important;
        }

        .dashboard-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%) !important;
            color: white !important;
        }

        .dashboard-btn:hover {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%) !important;
            color: white !important;
        }

        .reports-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%) !important;
            color: white !important;
        }

        .reports-btn:hover {
            background: linear-gradient(135deg, #2980b9 0%, #21618c 100%) !important;
            color: white !important;
        }

        .logout-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
            color: white !important;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%) !important;
            color: white !important;
        }

        /* Welcome Message Row */
        .welcome-message-row {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            padding: 0.5rem 0 !important;
            border-top: 1px solid rgba(0, 0, 0, 0.05) !important;
        }

        .welcome-container {
            display: flex !important;
            align-items: center !important;
            gap: 0.75rem !important;
            background: rgba(255, 255, 255, 0.9) !important;
            padding: 0.5rem 1rem !important;
            border-radius: 15px !important;
            backdrop-filter: blur(10px) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            transition: all 0.3s ease !important;
        }

        .welcome-container:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15) !important;
        }

        .welcome-icon {
            width: 30px !important;
            height: 30px !important;
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%) !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            color: white !important;
            font-size: 1rem !important;
        }

        .welcome-text {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
        }

        .welcome-greeting {
            color: #7f8c8d !important;
            font-size: 0.9rem !important;
        }

        .user-name {
            color: #2c3e50 !important;
            font-weight: 700 !important;
            font-size: 1.2rem !important;
            display: block !important;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-nav {
                justify-content: center !important;
                margin-top: 1rem !important;
            }

            .nav-buttons {
                flex-wrap: wrap !important;
                justify-content: center !important;
            }

            .welcome-container {
                flex-direction: column !important;
                text-align: center !important;
                padding: 0.5rem !important;
            }

            .welcome-text {
                align-items: center !important;
                flex-direction: row !important;
            }
        }
        
        .main-content {
            padding: 2rem 0;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border: none;
            border-radius: 20px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
        }
        
        .prompt-textarea {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .response-box {
            min-height: 300px;
            max-height: 600px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        
        .btn-send {
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border-width: 2px;
        }
        
        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .btn-outline-primary {
            border-color: #3498db;
            color: #3498db;
        }
        
        .btn-outline-primary:hover {
            background-color: #3498db;
            border-color: #3498db;
            color: white;
        }
        
        .text-primary {
            color: #3498db !important;
        }
        
        .text-danger {
            color: #e74c3c !important;
        }
        
        .loading {
            display: none;
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        
        .model-selector {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 1.5rem;
        }
        
        .agent-icon {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s ease;
        }
        
        .agent-icon:hover {
            transform: scale(1.05);
        }
        
        .tools-section, .reasoning-section {
            padding: 0.5rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        /* Clean agentic mode styling */
        .ai-response-container.agentic-mode {
            border: 1px solid #e9ecef;
            border-radius: 12px;
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .agent-badge .badge {
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .agent-details {
            border-top: 1px solid #f1f3f4;
            padding-top: 1rem;
        }
        
        .agent-details .btn {
            border: 1px solid #dee2e6;
            color: #6c757d;
            font-size: 0.85rem;
            padding: 0.375rem 0.75rem;
        }
        
        .agent-details .btn:hover {
            background-color: #f8f9fa;
            border-color: #adb5bd;
        }
        
        .agent-detail-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .agent-detail-section h6 {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .tools-list .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .collapse .btn[aria-expanded="true"] .bi-chevron-down {
            transform: rotate(180deg);
        }
        
        .collapse .btn .bi-chevron-down {
            transition: transform 0.2s ease;
        }
        
        .agent-info-card {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .agent-info-card.planning {
            border-left-color: #28a745;
        }
        
        .agent-info-card.analytics {
            border-left-color: #17a2b8;
        }
        
        .agent-info-card.advisor {
            border-left-color: #ffc107;
        }
        
        .agent-info-card.general {
            border-left-color: #007bff;
        }
        
        .ai-response-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }
        
        .ai-response-container:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }
        
        .ai-response-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ai-response-header.traditional-mode {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .ai-response-header.error-header {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .ai-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .ai-response-header h5 {
            color: white !important;
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0;
        }
        
        .ai-response-header small {
            color: rgba(255, 255, 255, 0.9) !important;
            font-size: 0.9rem;
        }
        
        .response-status {
            display: flex;
            align-items: center;
        }
        
        .response-status .badge {
            font-size: 0.85rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .ai-response-content {
            padding: 2rem;
            line-height: 1.7;
            font-size: 1rem;
            color: #2c3e50;
        }
        
        .ai-response-content h1,
        .ai-response-content h2,
        .ai-response-content h3,
        .ai-response-content h4,
        .ai-response-content h5,
        .ai-response-content h6 {
            color: #2c3e50;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .ai-response-content h1:first-child,
        .ai-response-content h2:first-child,
        .ai-response-content h3:first-child,
        .ai-response-content h4:first-child,
        .ai-response-content h5:first-child,
        .ai-response-content h6:first-child {
            margin-top: 0;
        }
        
        .ai-response-content ul,
        .ai-response-content ol {
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .ai-response-content li {
            margin-bottom: 0.5rem;
        }
        
        .ai-response-content p {
            margin-bottom: 1rem;
        }
        
        .ai-response-content strong {
            color: #34495e;
            font-weight: 600;
        }
        
        .ai-response-content code {
            background: #f1f3f4;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            color: #e74c3c;
        }
        
        .ai-response-content pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
        }
        
        .ai-response-content pre code {
            background: none;
            color: inherit;
            padding: 0;
        }
        
        .ai-response-content blockquote {
            border-left: 4px solid #3498db;
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: #7f8c8d;
        }
        
        .ai-response-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .ai-response-content th,
        .ai-response-content td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .ai-response-content th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* Markdown-specific styling */
        .ai-response-content h1,
        .ai-response-content h2,
        .ai-response-content h3,
        .ai-response-content h4,
        .ai-response-content h5,
        .ai-response-content h6 {
            color: #2c3e50;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 0.5rem;
        }
        
        .ai-response-content h1:first-child,
        .ai-response-content h2:first-child,
        .ai-response-content h3:first-child,
        .ai-response-content h4:first-child,
        .ai-response-content h5:first-child,
        .ai-response-content h6:first-child {
            margin-top: 0;
        }
        
        .ai-response-content strong {
            color: #34495e;
            font-weight: 700;
        }
        
        .ai-response-content em {
            color: #7f8c8d;
            font-style: italic;
        }
        
        .ai-response-content ul,
        .ai-response-content ol {
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .ai-response-content li {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }
        
        .ai-response-content p {
            margin-bottom: 1rem;
            line-height: 1.7;
        }
        
        .ai-response-content blockquote {
            border-left: 4px solid #3498db;
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: #7f8c8d;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
        }
        
        .ai-response-content hr {
            border: none;
            height: 2px;
            background: linear-gradient(to right, #3498db, #ecf0f1);
            margin: 2rem 0;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="assistant-header">
        <div class="container">
            <div class="row align-items-center py-3">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <div class="header-logo me-3">
                            <i class="bi bi-robot"></i>
                        </div>
                        <div>
                            <div class="header-title">AI Assistant</div>
                            <div class="header-subtitle">Smart Planning Helper</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="header-nav">
                        <div class="nav-buttons">
                            <a href="/dashboard" class="nav-btn dashboard-btn" title="Go to Dashboard">
                                <i class="bi bi-house"></i>
                                <span class="btn-text">Dashboard</span>
                            </a>
                            <a href="/reports" class="nav-btn reports-btn" title="View Reports">
                                <i class="bi bi-graph-up"></i>
                                <span class="btn-text">Reports</span>
                            </a>
                            <a href="/kanban" class="nav-btn kanban-btn" title="Kanban Board">
                                <i class="bi bi-columns-gap"></i>
                                <span class="btn-text">Kanban</span>
                            </a>
                            <button class="nav-btn timezone-btn" onclick="openTimezoneSettings()" title="Change Timezone">
                                <i class="bi bi-gear"></i>
                                <span class="btn-text">Timezone</span>
                            </button>
                            <a href="#" onclick="logout()" class="nav-btn logout-btn" title="Logout">
                                <i class="bi bi-box-arrow-right"></i>
                                <span class="btn-text">Logout</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Welcome Message Row -->
            <div class="row">
                <div class="col-12">
                    <div class="welcome-message-row">
                        <div class="welcome-container">
                            <div class="welcome-icon">
                                <i class="bi bi-person-circle"></i>
                            </div>
                            <div class="welcome-text">
                                <span class="welcome-greeting">Welcome back, </span>
                                <span class="user-name" id="userName"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <!-- System Selection -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card model-selector">
                        <div class="card-body">
                            <h5 class="card-title mb-3">
                                <i class="bi bi-gear me-2"></i>
                                AI System Configuration
                            </h5>
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="agenticMode" onchange="toggleAgenticMode()">
                                        <label class="form-check-label" for="agenticMode">
                                            <strong>Enable Agentic AI System</strong> (Advanced multi-agent routing)
                                        </label>
                                    </div>
                                    <small class="text-muted">When enabled, your requests will be automatically routed to specialized agents (Planning, Analytics, Advisor, General)</small>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <label for="modelSelect" class="form-label">Choose Model</label>
                                    <select class="form-select" id="modelSelect" onchange="updateModelInfo()">
                                        <option value="">Select a model...</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <div id="modelInfo" class="mt-3" style="display: none;">
                                        <small class="text-muted">
                                            <strong>Base URL:</strong> <span id="modelBaseUrl"></span><br>
                                            <strong>Model:</strong> <span id="modelName"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent Selection & System Prompt -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-robot me-2"></i>
                                <span id="systemPromptTitle">AI Agent & System Prompt</span>
                                <button class="btn btn-sm btn-outline-primary float-end" onclick="generateSystemPrompt()" id="regenerateBtn">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Regenerate
                                </button>
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Agentic System Info -->
                            <div id="agenticInfo" style="display: none;">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Detected Agent:</label>
                                        <div id="detectedAgent" class="badge bg-success fs-6 p-2">
                                            <i class="bi bi-robot me-1"></i>Auto-detecting...
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Agent Description:</label>
                                        <div id="agentDescription" class="text-muted small">
                                            AI will automatically select the best agent for your request
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>Agentic Mode:</strong> Your request will be automatically routed to the most appropriate specialized agent (Planning, Analytics, Advisor, or General).
                                </div>
                            </div>
                            
                            <!-- Traditional System Info -->
                            <div id="traditionalInfo">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Selected Agent:</label>
                                        <div id="selectedAgent" class="badge bg-primary fs-6 p-2">
                                            <i class="bi bi-robot me-1"></i>General Assistant
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Agent Description:</label>
                                        <div id="agentDescriptionTraditional" class="text-muted small">
                                            Handles general questions and provides basic assistance
                                        </div>
                                    </div>
                                </div>
                                <textarea class="form-control prompt-textarea" id="systemPrompt" placeholder="System prompt will be generated automatically based on your request..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Prompt -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-person me-2"></i>
                                Your Request
                            </h5>
                        </div>
                        <div class="card-body">
                            <textarea class="form-control prompt-textarea" id="userPrompt" placeholder="Describe what you want the AI to help you with... (e.g., generate a plan for tomorrow based on my tasks which includes 2 hours of practicing sports)" oninput="generateSystemPrompt()" onkeyup="if(document.getElementById('agenticMode').checked) updateDetectedAgent()"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Send Button -->
            <div class="row mb-4">
                <div class="col-12 text-center">
                    <button class="btn btn-outline-primary btn-send" onclick="sendRequest()" id="sendButton">
                        <i class="bi bi-send me-2"></i>
                        Send Request
                    </button>
                    <div class="loading mt-2" id="loadingIndicator">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="text-muted">Processing request...</span>
                    </div>
                </div>
            </div>

            <!-- Response -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-chat-dots me-2"></i>
                                AI Response
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="response-box" id="responseBox">
                                <div class="text-muted text-center">
                                    <i class="bi bi-robot fs-1"></i>
                                    <p class="mt-2">AI assistant will respond here...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i id="toastIcon" class="bi me-2"></i>
                <strong id="toastTitle" class="me-auto"></strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div id="toastBody" class="toast-body"></div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let models = [];
        let userData = null;
        let projects = [];
        let tasks = [];
        let activities = [];
        let reminders = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Assistant page initializing...');
            
            // Check API key first
            const apiKey = localStorage.getItem('apiKey');
            console.log('API key found:', !!apiKey);
            
            if (!apiKey) {
                console.log('No API key found, redirecting to login...');
                window.location.href = '/login';
                return;
            }
            
            loadUserInfo();
            loadModels();
            loadData();
        });

        function loadUserInfo() {
            console.log('Loading user info...');
            const displayName = localStorage.getItem('displayName');
            const username = localStorage.getItem('username');
            const userName = displayName || username || 'User';
            
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
                userNameElement.textContent = userName;
            }
        }

        async function loadModels() {
            try {
                const apiKey = localStorage.getItem('apiKey');
                if (!apiKey) {
                    console.error('No API key found for loading models');
                    return;
                }

                const response = await fetch('/models/', {
                    headers: {
                        'X-API-Key': apiKey
                    }
                });

                if (response.ok) {
                    models = await response.json();
                    console.log('Loaded models:', models);
                    
                    const modelSelect = document.getElementById('modelSelect');
                    modelSelect.innerHTML = '<option value="">Select a model...</option>';
                    
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.api_key;
                        option.textContent = `${model.name} (${model.base_url})`;
                        modelSelect.appendChild(option);
                    });
                } else {
                    console.error('Failed to load models:', response.status);
                    showToast('Error', 'Failed to load models', 'danger');
                }
            } catch (error) {
                console.error('Error loading models:', error);
                showToast('Error', 'Failed to load models', 'danger');
            }
        }

        async function loadData() {
            try {
                const apiKey = localStorage.getItem('apiKey');
                if (!apiKey) return;

                // Load all data in parallel
                const [projectsRes, tasksRes, activitiesRes, remindersRes] = await Promise.all([
                    fetch('/projects/', { headers: { 'X-API-Key': apiKey } }),
                    fetch('/tasks/', { headers: { 'X-API-Key': apiKey } }),
                    fetch('/activities/', { headers: { 'X-API-Key': apiKey } }),
                    fetch('/reminders/today', { headers: { 'X-API-Key': apiKey } })
                ]);

                if (projectsRes.ok) projects = await projectsRes.json();
                if (tasksRes.ok) tasks = await tasksRes.json();
                if (activitiesRes.ok) activities = await activitiesRes.json();
                if (remindersRes.ok) reminders = await remindersRes.json();

                console.log('Loaded data:', { projects: projects.length, tasks: tasks.length, activities: activities.length, reminders: reminders.length });
                
                // Generate initial system prompt
                generateSystemPrompt();
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error', 'Failed to load data', 'danger');
            }
        }

        // Agent-based system for better performance
        const agents = {
            planner: {
                name: "Planning Agent",
                description: "Specializes in task prioritization, scheduling, and project planning",
                keywords: ["plan", "schedule", "prioritize", "organize", "deadline", "urgent", "important"]
            },
            analyst: {
                name: "Analytics Agent", 
                description: "Analyzes time tracking, productivity patterns, and performance metrics",
                keywords: ["analyze", "time", "productivity", "efficiency", "pattern", "report", "statistics"]
            },
            advisor: {
                name: "Advisory Agent",
                description: "Provides general advice, tips, and best practices for productivity",
                keywords: ["advice", "tip", "help", "how", "best practice", "suggestion", "recommendation"]
            },
            assistant: {
                name: "General Assistant",
                description: "Handles general questions and provides basic assistance",
                keywords: ["what", "when", "where", "why", "how", "explain", "define"]
            }
        };

        function detectAgent(userPrompt) {
            const prompt = userPrompt.toLowerCase();
            let bestAgent = 'assistant';
            let maxScore = 0;

            for (const [agentName, agent] of Object.entries(agents)) {
                let score = 0;
                agent.keywords.forEach(keyword => {
                    if (prompt.includes(keyword)) {
                        score += 1;
                    }
                });
                if (score > maxScore) {
                    maxScore = score;
                    bestAgent = agentName;
                }
            }
            return bestAgent;
        }

        // Toggle between agentic and traditional modes
        function toggleAgenticMode() {
            const agenticMode = document.getElementById('agenticMode').checked;
            const agenticInfo = document.getElementById('agenticInfo');
            const traditionalInfo = document.getElementById('traditionalInfo');
            const systemPromptTitle = document.getElementById('systemPromptTitle');
            const regenerateBtn = document.getElementById('regenerateBtn');
            
            if (agenticMode) {
                agenticInfo.style.display = 'block';
                traditionalInfo.style.display = 'none';
                systemPromptTitle.textContent = 'Agentic AI System';
                regenerateBtn.style.display = 'none';
            } else {
                agenticInfo.style.display = 'none';
                traditionalInfo.style.display = 'block';
                systemPromptTitle.textContent = 'AI Agent & System Prompt';
                regenerateBtn.style.display = 'inline-block';
            }
            
            // Update detected agent when switching modes
            if (agenticMode) {
                updateDetectedAgent();
            }
        }

        function updateDetectedAgent() {
            const userPrompt = document.getElementById('userPrompt').value;
            if (!userPrompt.trim()) {
                document.getElementById('detectedAgent').innerHTML = '<i class="bi bi-robot me-1"></i>Auto-detecting...';
                document.getElementById('agentDescription').textContent = 'AI will automatically select the best agent for your request';
                return;
            }
            
            const selectedAgent = detectAgent(userPrompt);
            const agent = agents[selectedAgent];
            
            // Update detected agent UI
            const detectedAgentEl = document.getElementById('detectedAgent');
            detectedAgentEl.className = `badge fs-6 p-2 ${getAgentBadgeClass(selectedAgent)}`;
            detectedAgentEl.innerHTML = `<i class="bi ${getAgentIcon(selectedAgent)} me-1"></i>${agent.name}`;
            
            document.getElementById('agentDescription').textContent = agent.description;
        }

        function generateSystemPrompt() {
            const agenticMode = document.getElementById('agenticMode').checked;
            
            if (agenticMode) {
                updateDetectedAgent();
                return;
            }
            
            const userPrompt = document.getElementById('userPrompt').value;
            const selectedAgent = detectAgent(userPrompt);
            const agent = agents[selectedAgent];
            
            // Update UI to show selected agent
            updateAgentUI(selectedAgent, agent);
            
            // Create a much more concise and structured system prompt
            const systemPrompt = `You are a ${agent.name} specialized in ${agent.description}.

CURRENT CONTEXT:
- Projects: ${projects.length} active
- Tasks: ${tasks.length} total (${tasks.filter(t => t.state === 'todo').length} todo, ${tasks.filter(t => t.state === 'doing').length} doing, ${tasks.filter(t => t.state === 'done').length} done)
- Activities: ${activities.length} tracked
- Reminders: ${reminders.length} set

KEY DATA:
${getRelevantData(selectedAgent)}

INSTRUCTIONS:
- Provide concise, actionable responses
- Focus on ${agent.description.toLowerCase()}
- Use bullet points for clarity
- Prioritize urgent/important tasks when relevant
- Keep responses under 500 words unless specifically asked for detailed analysis`;

            document.getElementById('systemPrompt').value = systemPrompt;
        }

        function updateAgentUI(agentName, agent) {
            const selectedAgentEl = document.getElementById('selectedAgent');
            const agentDescriptionEl = document.getElementById('agentDescription');
            
            // Update agent badge with color coding
            selectedAgentEl.className = `badge fs-6 p-2 ${getAgentBadgeClass(agentName)}`;
            selectedAgentEl.innerHTML = `<i class="bi ${getAgentIcon(agentName)} me-1"></i>${agent.name}`;
            
            // Update description
            agentDescriptionEl.textContent = agent.description;
        }

        function getAgentBadgeClass(agentName) {
            const classes = {
                'planner': 'bg-success',
                'analyst': 'bg-info', 
                'advisor': 'bg-warning',
                'assistant': 'bg-primary'
            };
            return classes[agentName] || 'bg-primary';
        }

        function getAgentIcon(agentName) {
            const icons = {
                'planner': 'bi-calendar-check',
                'analyst': 'bi-graph-up',
                'advisor': 'bi-lightbulb',
                'assistant': 'bi-robot',
                'planning': 'bi-calendar-check',
                'analytics': 'bi-graph-up',
                'advisor': 'bi-lightbulb',
                'general': 'bi-robot'
            };
            return icons[agentName] || 'bi-robot';
        }

        function getAgentBadgeClass(agentName) {
            const classes = {
                'planner': 'bg-success',
                'analyst': 'bg-info',
                'advisor': 'bg-warning',
                'assistant': 'bg-primary',
                'planning': 'bg-success',
                'analytics': 'bg-info',
                'advisor': 'bg-warning',
                'general': 'bg-primary'
            };
            return classes[agentName] || 'bg-primary';
        }

        function getAgentDisplayName(agentName) {
            const names = {
                'planner': 'Planning Agent',
                'analyst': 'Analytics Agent',
                'advisor': 'Advisory Agent',
                'assistant': 'General Assistant',
                'planning': 'Planning Agent',
                'analytics': 'Analytics Agent',
                'advisor': 'Advisory Agent',
                'general': 'General Assistant'
            };
            return names[agentName] || 'AI Assistant';
        }

        function getAgentDescription(agentName) {
            const descriptions = {
                'planner': 'Task prioritization & scheduling expert',
                'analyst': 'Productivity metrics & pattern analyst',
                'advisor': 'Productivity advice & best practices',
                'assistant': 'General assistance & support',
                'planning': 'Task prioritization & scheduling expert',
                'analytics': 'Productivity metrics & pattern analyst',
                'advisor': 'Productivity advice & best practices',
                'general': 'General assistance & support'
            };
            return descriptions[agentName] || 'AI Assistant';
        }

        function getRelevantData(agentType) {
            switch(agentType) {
                case 'planner':
                    return getPlanningData();
                case 'analyst':
                    return getAnalyticsData();
                case 'advisor':
                    return getAdvisoryData();
                default:
                    return getGeneralData();
            }
        }

        function getPlanningData() {
            const urgentTasks = tasks.filter(t => t.is_urgent && t.state !== 'done');
            const importantTasks = tasks.filter(t => t.is_important && t.state !== 'done');
            const upcomingDeadlines = tasks.filter(t => t.deadline && new Date(t.deadline) > new Date())
                .sort((a, b) => new Date(a.deadline) - new Date(b.deadline))
                .slice(0, 5);

            return `URGENT TASKS: ${urgentTasks.map(t => `${t.title} (${t.state})`).join(', ')}
IMPORTANT TASKS: ${importantTasks.slice(0, 3).map(t => `${t.title} (${t.state})`).join(', ')}
UPCOMING DEADLINES: ${upcomingDeadlines.map(t => `${t.title} - ${new Date(t.deadline).toLocaleDateString()}`).join(', ')}`;
        }

        function getAnalyticsData() {
            const totalTime = activities.reduce((sum, a) => {
                if (a.clock_in && a.clock_out) {
                    return sum + (new Date(a.clock_out) - new Date(a.clock_in));
                }
                return sum;
            }, 0);
            const avgSessionTime = activities.length > 0 ? Math.round(totalTime / activities.length / (1000 * 60)) : 0;
            const completedTasks = tasks.filter(t => t.state === 'done').length;
            const completionRate = tasks.length > 0 ? Math.round((completedTasks / tasks.length) * 100) : 0;

            return `PRODUCTIVITY METRICS:
- Total tracked time: ${Math.round(totalTime / (1000 * 60 * 60))} hours
- Average session: ${avgSessionTime} minutes  
- Completion rate: ${completionRate}%
- Active projects: ${projects.length}`;
        }

        function getAdvisoryData() {
            const lowEnergyTasks = tasks.filter(t => t.energy_level === 1).length;
            const highEnergyTasks = tasks.filter(t => t.energy_level === 3).length;
            const noDeadlineTasks = tasks.filter(t => !t.deadline && t.state !== 'done').length;

            return `CURRENT STATE:
- Low energy tasks: ${lowEnergyTasks}
- High energy tasks: ${highEnergyTasks}
- Tasks without deadlines: ${noDeadlineTasks}
- Active projects: ${projects.length}`;
        }

        function getGeneralData() {
            return `OVERVIEW:
- ${projects.length} projects, ${tasks.length} tasks, ${activities.length} activities
- Most recent activity: ${activities.length > 0 ? activities[activities.length - 1].description || 'No description' : 'None'}`;
        }

        function updateModelInfo() {
            const modelSelect = document.getElementById('modelSelect');
            const modelInfo = document.getElementById('modelInfo');
            const modelBaseUrl = document.getElementById('modelBaseUrl');
            const modelName = document.getElementById('modelName');

            if (modelSelect.value) {
                const selectedModel = models.find(m => m.api_key == modelSelect.value);
                if (selectedModel) {
                    modelBaseUrl.textContent = selectedModel.base_url;
                    modelName.textContent = selectedModel.name;
                    modelInfo.style.display = 'block';
                }
            } else {
                modelInfo.style.display = 'none';
            }
        }

        async function sendRequest() {
            const modelSelect = document.getElementById('modelSelect');
            const systemPrompt = document.getElementById('systemPrompt').value;
            const userPrompt = document.getElementById('userPrompt').value;
            const sendButton = document.getElementById('sendButton');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const responseBox = document.getElementById('responseBox');
            const agenticMode = document.getElementById('agenticMode').checked;

            if (!modelSelect.value) {
                showToast('Error', 'Please select a model first', 'warning');
                return;
            }

            if (!userPrompt.trim()) {
                showToast('Error', 'Please enter your request', 'warning');
                return;
            }

            const selectedModel = models.find(m => m.api_key == modelSelect.value);
            if (!selectedModel) {
                showToast('Error', 'Selected model not found', 'danger');
                return;
            }

            // Show loading state
            sendButton.disabled = true;
            loadingIndicator.style.display = 'block';
            responseBox.innerHTML = '<div class="text-muted text-center"><div class="spinner-border spinner-border-sm me-2"></div>Processing...</div>';

            try {
                const apiKey = localStorage.getItem('apiKey');
                let response;
                
                if (agenticMode) {
                    // Use agentic system
                    response = await fetch('/agentic-query', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': apiKey
                        },
                        body: JSON.stringify({
                            model_api_key: selectedModel.api_key,
                            user_prompt: userPrompt
                        })
                    });
                } else {
                    // Use traditional system
                    response = await fetch('/query', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': apiKey
                        },
                        body: JSON.stringify({
                            model_api_key: selectedModel.api_key,
                            system_prompt: systemPrompt,
                            user_prompt: userPrompt
                        })
                    });
                }

                if (response.ok) {
                    const result = await response.json();
                    
                    if (agenticMode) {
                        // Display agentic response with minimal design
                        responseBox.innerHTML = `
                            <div class="ai-response-container agentic-mode">
                                <div class="ai-response-content" id="ai-response-content">
                                    ${result.response}
                                </div>
                            </div>`;
                        
                        // Render markdown in the response
                        setTimeout(() => {
                            const contentElement = document.getElementById('ai-response-content');
                            if (contentElement) {
                                contentElement.innerHTML = marked.parse(result.response);
                            }
                        }, 100);
                    } else {
                        // Display traditional response with enhanced UI
                        responseBox.innerHTML = `
                            <div class="ai-response-container traditional-mode">
                                <div class="ai-response-header">
                                    <div class="d-flex align-items-center">
                                        <div class="ai-icon me-3">
                                            <i class="bi bi-robot-fill"></i>
                                        </div>
                                        <div>
                                            <h5 class="mb-1 text-dark fw-bold">AI Response</h5>
                                            <small class="text-muted">Traditional AI Assistant</small>
                                        </div>
                                    </div>
                                    <div class="response-status">
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle me-1"></i>Response received
                                        </span>
                                    </div>
                                </div>
                                <div class="ai-response-content" id="ai-response-content-traditional">
                                    ${result.response}
                                </div>
                            </div>`;
                        
                        // Render markdown in the traditional response
                        setTimeout(() => {
                            const contentElement = document.getElementById('ai-response-content-traditional');
                            if (contentElement) {
                                contentElement.innerHTML = marked.parse(result.response);
                            }
                        }, 100);
                    }
                    showToast('Success', 'Request processed successfully', 'success');
                } else {
                    const errorData = await response.json();
                    responseBox.innerHTML = `
                        <div class="ai-response-container error-mode">
                            <div class="ai-response-header error-header">
                                <div class="d-flex align-items-center">
                                    <div class="ai-icon me-3">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-1 text-white fw-bold">Error</h5>
                                        <small class="text-white-50">Request failed</small>
                                    </div>
                                </div>
                                <div class="response-status">
                                    <span class="badge bg-danger">
                                        <i class="bi bi-x-circle me-1"></i>Error
                                    </span>
                                </div>
                            </div>
                            <div class="ai-response-content">
                                <div class="alert alert-danger border-0 mb-0">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong>Error:</strong> ${errorData.detail || 'Failed to process request'}
                                </div>
                            </div>
                        </div>`;
                    showToast('Error', 'Failed to process request', 'danger');
                }
            } catch (error) {
                console.error('Error sending request:', error);
                responseBox.innerHTML = `
                    <div class="ai-response-container error-mode">
                        <div class="ai-response-header error-header">
                            <div class="d-flex align-items-center">
                                <div class="ai-icon me-3">
                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1 text-white fw-bold">Network Error</h5>
                                    <small class="text-white-50">Connection failed</small>
                                </div>
                            </div>
                            <div class="response-status">
                                <span class="badge bg-danger">
                                    <i class="bi bi-wifi-off me-1"></i>Offline
                                </span>
                            </div>
                        </div>
                        <div class="ai-response-content">
                            <div class="alert alert-danger border-0 mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Network Error:</strong> ${error.message}
                            </div>
                        </div>
                    </div>`;
                showToast('Error', 'Failed to send request', 'danger');
            } finally {
                // Hide loading state
                sendButton.disabled = false;
                loadingIndicator.style.display = 'none';
            }
        }

        function showToast(title, message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastTitle = document.getElementById('toastTitle');
            const toastBody = document.getElementById('toastBody');
            const toastIcon = document.getElementById('toastIcon');

            toastTitle.textContent = title;
            toastBody.textContent = message;
            
            // Set icon based on type
            toastIcon.className = `bi ${type === 'success' ? 'bi-check-circle text-success' : 
                                   type === 'danger' ? 'bi-exclamation-triangle text-danger' : 
                                   type === 'warning' ? 'bi-exclamation-triangle text-warning' : 
                                   'bi-info-circle text-info'}`;

            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }

        // Timezone management
        let userTimezone = 'Asia/Tehran'; // Default timezone
        let availableTimezones = [];

        // Load user timezone
        async function loadUserTimezone() {
            try {
                const apiKey = localStorage.getItem('apiKey');
                const response = await fetch('/users/timezone', {
                    headers: {
                        'X-API-Key': apiKey
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    userTimezone = data.timezone;
                    availableTimezones = data.available_timezones;
                }
            } catch (error) {
                console.error('Error loading user timezone:', error);
            }
        }

        // Open timezone settings modal
        async function openTimezoneSettings() {
            console.log('openTimezoneSettings called - version 1.4');
            // Ensure timezone data is loaded before opening modal
            if (!availableTimezones || Object.keys(availableTimezones).length === 0) {
                console.log('Timezone data not loaded, loading now...');
                await loadUserTimezone();
            }
            
            const modal = new bootstrap.Modal(document.getElementById('timezoneSettingsModal'));
            populateTimezoneCountrySelect();
            setupTimezoneEventListeners(); // Set up event listeners after modal is opened
            modal.show();
        }

        // Populate timezone country select dropdown
        function populateTimezoneCountrySelect() {
            const countrySelect = document.getElementById('timezoneCountrySelect');
            const citySelect = document.getElementById('timezoneCitySelect');
            
            // Clear both selects
            countrySelect.innerHTML = '<option value="">Select a country</option>';
            citySelect.innerHTML = '<option value="">Select a country first</option>';
            citySelect.disabled = true;
            
            if (!availableTimezones || typeof availableTimezones !== 'object') {
                console.error('Available timezones is not an object:', availableTimezones);
                return;
            }
            
            // Add countries to the dropdown
            Object.keys(availableTimezones).forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });
            
            // Try to pre-select the current user's country
            const currentUserTimezone = userTimezone;
            if (currentUserTimezone) {
                for (const [country, cities] of Object.entries(availableTimezones)) {
                    for (const city of cities) {
                        if (city.value === currentUserTimezone) {
                            countrySelect.value = country;
                            populateTimezoneCitySelect(country);
                            // Find and select the current city
                            for (const cityOption of citySelect.options) {
                                if (cityOption.value === currentUserTimezone) {
                                    cityOption.selected = true;
                                    break;
                                }
                            }
                            break;
                        }
                    }
                }
            }
            
            updateTimezonePreview();
        }

        // Populate timezone city select dropdown
        function populateTimezoneCitySelect(country) {
            const citySelect = document.getElementById('timezoneCitySelect');
            citySelect.innerHTML = '<option value="">Select a city</option>';
            
            if (!country || !availableTimezones[country]) {
                citySelect.disabled = true;
                return;
            }
            
            citySelect.disabled = false;
            
            availableTimezones[country].forEach(city => {
                const option = document.createElement('option');
                option.value = city.value;
                option.textContent = city.label;
                citySelect.appendChild(option);
            });
        }

        // Set up timezone event listeners
        function setupTimezoneEventListeners() {
            const countrySelect = document.getElementById('timezoneCountrySelect');
            const citySelect = document.getElementById('timezoneCitySelect');
            
            if (countrySelect) {
                countrySelect.addEventListener('change', function() {
                    const selectedCountry = this.value;
                    populateTimezoneCitySelect(selectedCountry);
                    updateTimezonePreview();
                });
            }
            
            if (citySelect) {
                citySelect.addEventListener('change', updateTimezonePreview);
            }
        }

        // Update timezone preview
        function updateTimezonePreview() {
            const citySelect = document.getElementById('timezoneCitySelect');
            const preview = document.getElementById('timezonePreview');
            const selectedTimezone = citySelect.value;
            
            if (selectedTimezone) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', {
                    hour12: false,
                    timeZone: selectedTimezone
                });
                const timezoneAbbr = getTimezoneAbbreviation(selectedTimezone);
                preview.textContent = `${timeString} ${timezoneAbbr}`;
            } else {
                preview.textContent = '--:--';
            }
        }

        // Get timezone abbreviation
        function getTimezoneAbbreviation(timezone) {
            const date = new Date();
            const options = { timeZoneName: 'short' };
            return date.toLocaleDateString('en-US', options).split(', ')[1];
        }

        // Update user timezone
        async function updateTimezone() {
            const citySelect = document.getElementById('timezoneCitySelect');
            const newTimezone = citySelect.value;
            
            if (!newTimezone) {
                showToast('Validation Error', 'Please select a city', 'warning');
                return;
            }

            try {
                const apiKey = localStorage.getItem('apiKey');
                const response = await fetch('/users/timezone', {
                    method: 'POST',
                    headers: {
                        'X-API-Key': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        timezone: newTimezone
                    })
                });

                if (response.ok) {
                    userTimezone = newTimezone;
                    showToast('Success!', 'Timezone updated successfully!', 'success');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('timezoneSettingsModal'));
                    modal.hide();
                } else {
                    const errorData = await response.json();
                    showToast('Error', `Failed to update timezone: ${errorData.detail || 'Unknown error'}`, 'danger');
                }
            } catch (error) {
                console.error('Error updating timezone:', error);
                showToast('Error', `Error updating timezone: ${error.message}`, 'danger');
            }
        }

        // Load timezone on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                loadUserTimezone();
            }, 1000);
        });
    </script>

    <!-- Timezone Settings Modal -->
    <div class="modal fade" id="timezoneSettingsModal" tabindex="-1" aria-labelledby="timezoneSettingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="timezoneSettingsModalLabel">
                        <i class="bi bi-gear me-2"></i>
                        Timezone Settings
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="timezoneSettingsForm">
                        <div class="mb-3">
                            <label for="timezoneCountrySelect" class="form-label">Select Country</label>
                            <select class="form-select" id="timezoneCountrySelect" required>
                                <option value="">Loading countries...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="timezoneCitySelect" class="form-label">Select City</label>
                            <select class="form-select" id="timezoneCitySelect" required disabled>
                                <option value="">Select a country first</option>
                            </select>
                            <div class="form-text">This will affect how times are displayed throughout the app.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Current Time in Selected Timezone</label>
                            <div class="form-control-plaintext" id="timezonePreview">--:--</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateTimezone()">
                        <i class="bi bi-check-circle me-1"></i>
                        Save Timezone
                    </button>
                </div>
            </div>
        </div>
    </div>


</body>
</html> 